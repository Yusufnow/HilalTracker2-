<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hilal Explorer Pro</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#000000">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #000; color: white; overflow: hidden; }
        
        /* Layout */
        #map { width: 100%; height: 60vh; z-index: 1; background: #000; }
        #panel { height: 40vh; background: #111; border-top: 2px solid #333; display: flex; flex-direction: column; }

        /* Schwebende Suche */
        .controls {
            position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
            z-index: 1000; display: flex; gap: 8px; width: 95%; max-width: 400px;
        }
        input { 
            padding: 12px; border-radius: 25px; border: none; font-size: 16px; 
            background: rgba(255,255,255,0.95); box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            flex: 1; outline: none;
        }
        #dateInput { max-width: 140px; font-family: monospace; }

        /* Tabs unten */
        .tabs { display: flex; background: #1a1a1a; border-bottom: 1px solid #333; }
        .tab { 
            flex: 1; padding: 15px; text-align: center; cursor: pointer; 
            font-weight: 500; color: #888; transition: 0.2s;
        }
        .tab.active { color: #4facfe; border-bottom: 3px solid #4facfe; background: #222; }
        
        /* Inhalt Bereiche */
        .content { display: none; padding: 20px; overflow-y: auto; height: 100%; }
        .content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from {opacity:0} to {opacity:1} }

        /* Datenausgabe */
        .data-row { 
            display: flex; justify-content: space-between; padding: 12px 0; 
            border-bottom: 1px solid #222; font-size: 15px; 
        }
        .data-row span:first-child { color: #aaa; }
        .data-row b { color: #fff; }

        /* Himmels Canvas */
        #skyCanvas { 
            width: 100%; height: 200px; background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); 
            border-radius: 12px; margin-top: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        /* Ladeanzeige */
        #loading {
            position: fixed; top: 60vh; left: 50%; transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.7); color: white; padding: 10px 20px;
            border-radius: 20px; display: none; z-index: 2000; pointer-events: none;
        }
    </style>
</head>
<body>

    <div class="controls">
        <input type="datetime-local" id="dateInput">
        <input type="text" id="citySearch" placeholder="üîç Stadt suchen...">
    </div>

    <div id="map"></div>
    <div id="loading">Berechne Sichtbarkeit...</div>

    <div id="panel">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('moon')">üåô Mond</div>
            <div class="tab" onclick="switchTab('sky')">üåå Himmel</div>
            <div class="tab" onclick="switchTab('qibla')">üïã Qibla</div>
        </div>

        <div id="moon" class="content active">
            <div style="display:flex; align-items:center; gap:20px; margin-bottom:15px;">
                <canvas id="moonCanvas" width="70" height="70"></canvas>
                <div>
                    <h2 id="locName" style="margin:0; font-size:18px;">Geladener Ort</h2>
                    <div id="moonPerc" style="color:#4facfe; font-weight:bold;">--%</div>
                </div>
            </div>
            <div id="astroData"></div>
        </div>

        <div id="sky" class="content">
            <div style="text-align:center; color:#888; font-size:13px; margin-bottom:5px;">
                Blick nach Westen (Sonnenuntergang)
            </div>
            <canvas id="skyCanvas"></canvas>
        </div>

        <div id="qibla" class="content">
            <div class="data-row">
                <span>üïã Qibla Richtung</span>
                <b id="qiblaDir">--¬∞</b>
            </div>
            <div class="data-row">
                <span>üìè Entfernung</span>
                <b id="kaabaDist">-- km</b>
            </div>
            <p style="color:#666; font-size:13px; margin-top:15px; text-align:center;">
                Die gelbe Linie auf der Karte zeigt direkt zur Kaaba in Mekka.
            </p>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/astronomy-engine@2.1.19/astronomy.browser.min.js"></script>

    <script>
        // --- HAUPT LOGIK (Alles in einem Script) ---
        
        let map, gridLayer, qiblaLine, marker;
        let selectedLat = 21.4225; // Start: Mekka
        let selectedLon = 39.8262;

        window.onload = function() {
            initMap();
            setupInputs();
            updateAll();
        };

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([selectedLat, selectedLon], 4);
            
            L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Esri', maxZoom: 18
            }).addTo(map);

            gridLayer = L.layerGroup().addTo(map);

            map.on('click', (e) => {
                selectedLat = e.latlng.lat;
                selectedLon = e.latlng.lng;
                document.getElementById("locName").innerText = "Markierter Ort";
                updateLocationData(); // Nur Daten updaten
            });
        }

        function setupInputs() {
            // Datum auf Heute setzen (Lokale Zeit korrigiert)
            const now = new Date();
            const localIso = new Date(now.getTime() - (now.getTimezoneOffset() * 60000)).toISOString().slice(0,16);
            document.getElementById("dateInput").value = localIso;

            document.getElementById("dateInput").addEventListener("change", updateAll);

            // Stadtsuche
            document.getElementById("citySearch").addEventListener("change", async function() {
                const q = this.value;
                if(!q) return;
                try {
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}`);
                    const data = await res.json();
                    if(data.length > 0) {
                        selectedLat = parseFloat(data[0].lat);
                        selectedLon = parseFloat(data[0].lon);
                        map.setView([selectedLat, selectedLon], 8);
                        document.getElementById("locName").innerText = data[0].display_name.split(",")[0];
                        updateLocationData();
                    } else { alert("Ort nicht gefunden"); }
                } catch(e) { console.error(e); }
            });
        }

        // Aktualisiert ALLES (Karte + Daten)
        function updateAll() {
            updateLocationData();
            drawVisibilityMap();
        }

        // Aktualisiert nur die Daten unten (schnell)
        function updateLocationData() {
            const date = new Date(document.getElementById("dateInput").value);
            
            // Marker setzen
            if(marker) map.removeLayer(marker);
            marker = L.marker([selectedLat, selectedLon]).addTo(map);

            // 1. Mond Daten
            const observer = new Astronomy.Observer(selectedLat, selectedLon, 0);
            const phase = Astronomy.MoonPhase(date);
            const illum = Astronomy.Illumination(Astronomy.Body.Moon, date);
            document.getElementById("moonPerc").innerText = (illum.phase_fraction * 100).toFixed(1) + "% beleuchtet";
            
            drawMoonIcon(phase); // Mond Bild malen

            // Zeiten berechnen (Aufgang/Untergang)
            const sunSet = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, -1, date, 300);
            const moonRise = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, +1, date, 300);
            const moonSet = Astronomy.SearchRiseSet(Astronomy.Body.Moon, observer, -1, date, 300);

            let html = "";
            if(sunSet) html += row("üåÖ Sonnenuntergang", fmtTime(sunSet.date));
            if(moonRise) html += row("üåë Mondaufgang", fmtTime(moonRise.date));
            if(moonSet) html += row("üåò Monduntergang", fmtTime(moonSet.date));
            html += row("üìÖ Mondalter", (phase/360*29.53).toFixed(1) + " Tage");
            document.getElementById("astroData").innerHTML = html;

            // 2. Himmel malen
            drawSky(date, observer);

            // 3. Qibla berechnen
            calcQibla();
        }

        // --- Die bunte Karte (Odeh Logik) ---
        function drawVisibilityMap() {
            const loading = document.getElementById("loading");
            loading.style.display = "block";
            gridLayer.clearLayers();

            const date = new Date(document.getElementById("dateInput").value);
            // Wir pr√ºfen 12:00 UTC dieses Tages
            const checkDate = new Date(date);
            checkDate.setUTCHours(12,0,0,0);

            setTimeout(() => {
                const step = 4; // Raster Gr√∂√üe
                for(let lat=60; lat>=-60; lat-=step) {
                    for(let lon=-180; lon<=180; lon+=step) {
                        const res = calculateOdeh(lat, lon, checkDate);
                        if(res.visible) {
                            L.circleMarker([lat, lon], {
                                radius: 4, fillColor: res.color, color: res.color,
                                weight: 0, fillOpacity: 0.5
                            }).addTo(gridLayer);
                        }
                    }
                }
                loading.style.display = "none";
            }, 100);
        }

        function calculateOdeh(lat, lon, date) {
            const observer = new Astronomy.Observer(lat, lon, 0);
            const sunset = Astronomy.SearchRiseSet(Astronomy.Body.Sun, observer, +1, date, 1);
            if(!sunset) return {visible:false};

            const t = sunset.date;
            const sunPos = Astronomy.Equator(Astronomy.Body.Sun, t, observer, true, true);
            const moonPos = Astronomy.Equator(Astronomy.Body.Moon, t, observer, true, true);
            const moonHor = Astronomy.Horizon(t, observer, moonPos.ra, moonPos.dec, 'normal');

            const alt = moonHor.alt;
            const w = Math.abs(Astronomy.AngleBetween(sunPos.vec, moonPos.vec)); // Elongation

            if(alt <= 0.5 || w <= 6.4) return {visible:false};

            // Vereinfachte Odeh/Yallop Parabel
            let V = alt - (-0.1018*Math.pow(w,2) + 1.6787*w - 5.5704);

            if(V >= 5.6) return {visible:true, color:'#00FF00'}; // Gr√ºn
            if(V >= 2.0) return {visible:true, color:'#FF00FF'}; // Magenta
            if(V >= -0.9) return {visible:true, color:'#0055FF'}; // Blau
            return {visible:false};
        }

        // --- Himmelsansicht ---
        function drawSky(date, observer) {
            const canvas = document.getElementById("skyCanvas");
            canvas.width = canvas.clientWidth; canvas.height = 200;
            const ctx = canvas.getContext("2d");
            
            // Hintergrund schon im CSS, wir malen Horizont
            ctx.strokeStyle = "rgba(255,255,255,0.3)";
            ctx.beginPath(); ctx.moveTo(0,150); ctx.lineTo(canvas.width,150); ctx.stroke();

            const bodies = [
                {n:"Sonne", o:Astronomy.Body.Sun, c:"#FFD700", r:12},
                {n:"Mond", o:Astronomy.Body.Moon, c:"#FFF", r:10},
                {n:"Venus", o:Astronomy.Body.Venus, c:"#0FF", r:6},
                {n:"Jupiter", o:Astronomy.Body.Jupiter, c:"#FCD", r:5}
            ];

            bodies.forEach(b => {
                const eq = Astronomy.Equator(b.o, date, observer, true, true);
                const hor = Astronomy.Horizon(date, observer, eq.ra, eq.dec, 'normal');
                
                // Wir schauen nach Westen (270¬∞)
                let da = hor.az - 270;
                if(da > 180) da-=360; if(da < -180) da+=360;

                const x = (canvas.width/2) + (da*4);
                const y = 150 - (hor.alt*4);

                if(x>-20 && x<canvas.width+20 && y>-20 && y<canvas.height+20) {
                    ctx.fillStyle = b.c;
                    ctx.beginPath(); ctx.arc(x,y,b.r,0,6.28); ctx.fill();
                    if(hor.alt>-5) {
                        ctx.fillStyle="white"; ctx.font="11px sans-serif"; ctx.textAlign="center";
                        ctx.fillText(b.n, x, y+b.r+12);
                    }
                }
            });
        }

        // --- Qibla ---
        function calcQibla() {
            const kLat=21.4225, kLon=39.8262;
            const lat=selectedLat, lon=selectedLon;
            
            // Richtung
            const y = Math.sin((kLon-lon)*Math.PI/180);
            const x = Math.cos(lat*Math.PI/180)*Math.tan(kLat*Math.PI/180) - Math.sin(lat*Math.PI/180)*Math.cos((kLon-lon)*Math.PI/180);
            let q = (Math.atan2(y,x)*180/Math.PI + 360) % 360;
            document.getElementById("qiblaDir").innerText = q.toFixed(1)+"¬∞";

            // Linie zeichnen
            if(qiblaLine) map.removeLayer(qiblaLine);
            qiblaLine = L.polyline([[lat,lon],[kLat,kLon]], {color:'gold', dashArray:'5,10'}).addTo(map);

            // Distanz
            const R=6371; 
            const dLat=(kLat-lat)*Math.PI/180, dLon=(kLon-lon)*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(lat*Math.PI/180)*Math.cos(kLat*Math.PI/180)*Math.sin(dLon/2)**2;
            const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            document.getElementById("kaabaDist").innerText = dist.toFixed(0)+" km";
        }

        // --- Helfer ---
        function drawMoonIcon(phase) {
            const ctx = document.getElementById("moonCanvas").getContext("2d");
            ctx.clearRect(0,0,70,70);
            ctx.fillStyle="#111"; ctx.beginPath(); ctx.arc(35,35,30,0,6.28); ctx.fill();
            const lit = (1-Math.cos(phase*Math.PI/180))/2;
            ctx.fillStyle=`rgba(255,250,230,${lit})`; ctx.beginPath(); ctx.arc(35,35,30,0,6.28); ctx.fill();
        }
        function row(label, val) { return `<div class="data-row"><span>${label}</span><b>${val}</b></div>`; }
        function fmtTime(d) { return d.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'}); }
        function switchTab(id) {
            document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
